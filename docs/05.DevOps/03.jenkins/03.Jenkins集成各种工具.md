---
title: Jenkins集成各种工具
date: 2022-06-23 13:29:35
permalink: /pages/bc4b74/
categories:
  - DevOps
  - jenkins
tags:
  - 
author: 
  name: 小阳爱技术
  link: https://blog.abck8s.com
---

## Jenkins 集成各种工具

我们常用的工具有很多，例如编译java的、编译js以及禅道回调相关的工具都需要集成到Jenkins之中。

### Jenkins 集成 Maven

在 Jenkins 集成服务器上，我们需要安装 Maven 来编译和打包项目。

#### 安装Maven

部署 Maven 要求 JDK 必须是 1.7+。

> 下载链接：https://maven.apache.org/download.cgi

```bash
$ wget https://dlcdn.apache.org/maven/maven-3/3.8.6/binaries/apache-maven-3.8.6-bin.tar.gz

$ tar -xf apache-maven-3.8.6-bin.tar.gz -C /usr/local/
$ vim vim /etc/profile
$ export MAVEN_HOME=/usr/local/apache-maven-3.8.6
$ export PATH=$PATH:$MAVEN_HOME/bin
$ source /etc/profile
$ mvn --version
Apache Maven 3.8.6 (84538c9988a25aec085021c365c560670ad80f63)
Maven home: /usr/local/apache-maven-3.8.6
Java version: 1.8.0_332, vendor: Red Hat, Inc., runtime: /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.332.b09-1.el7_9.x86_64/jre
Default locale: en_US, platform encoding: UTF-8
OS name: "linux", version: "3.10.0-1160.66.1.el7.x86_64", arch: "amd64", family: "unix"
```

#### Jenkins 集成 maven

jenkins --> 系统配置 --> 全局工具配置

![image-20220621154628732](/img/image-20220621154628732.png)

![image-20220621154643488](/img/image-20220621154643488.png)

#### 添加Jenkins全局变量

jenkins --> 全局工具配置 --> 全局工具配置

![image-20220621155432312](/img/image-20220621155432312.png)

#### 优化Maven的settings.xml

```bash
$ mkdir -pv /data/software/repository
$ chown -R jenkins.jenkins /data/
```

修改详情

```xml
<!--本地仓库-->          
<localRepository>/data/software/repository</localRepository>

<mirrors>
    <!--阿里云镜像-->
    <mirror>
        <id>aliyun-maven</id>
        <mirrorOf>central</mirrorOf>
        <name>aliyun maven mirror</name>
        <url>http://maven.aliyun.com/nexus/content/groups/public/</url>
    </mirror>
</mirrors>
```

测试

```groovy
pipeline{
    agent any
    stages{
        stage("first stage"){
            steps("first steps"){
                script {
                    sh """
                    mvn -v
                    """
                }
            }
        }
    }
    post {
        always {
            echo "运行成功"
        }
    }
}
```

![image-20220621160950463](/img/image-20220621160950463.png)



### Jenkins 集成 Gradle

gradle 是一个 Java 构建自动化的工具,类似于maven,ant的功能。使用 gradle 可以给 java 项目编译,单元测试,打包,或者生成可执行的jar包等。

#### 安装 Gradle

Gradle 可在所有主要操作系统上运行，并且只需要安装Java JDK 8 或更高版本。

```bash
$ java -version
openjdk version "1.8.0_332"
OpenJDK Runtime Environment (build 1.8.0_332-b09)
OpenJDK 64-Bit Server VM (build 25.332-b09, mixed mode)
```

> 下载链接：https://gradle.org/install/

![image-20220621165658096](/img/image-20220621165658096.png)



```bash
$ wget https://downloads.gradle-dn.com/distributions/gradle-7.4.2-bin.zip
$ unzip gradle-7.4.2-bin.zip -d /usr/local/
$ vim /etc/profile
export GRADLE_HOME=/usr/local/gradle-7.4.2
export PATH=$PATH:$GRADLE_HOME/bin
$ source /etc/profile
```

#### Jenkins 集成 gradle

Jenkins->Manage Jenkins->Manage Plugins，点击Advanced

![image-20220621170203983](/img/image-20220621170203983.png)

jenkins --> 系统管理 --> 全局工具配置

![image-20220621170352424](/img/image-20220621170352424.png)

jenkins --> 全局工具配置 --> 全局工具配置

![image-20220621170501715](/img/image-20220621170501715.png)

测试

```groovy
pipeline{
    agent any
    stages{
        stage("first stage"){
            steps("first steps"){
                sh """
                    gradle -v
                """
            }
        }
    }
    post {
        always {
            echo "运行成功"
        }
    }
}
```

![image-20220621170553115](/img/image-20220621170553115.png)

### Jenkins 集成 Ant

Ant是跨平台的构建工具，它可以实现项目的自动构建和部署等功能。

#### 安装 Ant

> 下载路径：https://ant.apache.org/bindownload.cgi

```bash
$ wget https://dlcdn.apache.org//ant/binaries/apache-ant-1.10.12-bin.tar.gz
```

![image-20220621161524227](/img/image-20220621161524227.png)

```bash
$ tar -xf apache-ant-1.10.12-bin.tar.gz -C /usr/local/
$ vim /etc/profile
$ export ANT_HOME=/usr/local/apache-ant-1.10.12
$ export PATH=$PATH:$MAVEN_HOME/bin:$ANT_HOME/bin
$ source /etc/profile
```

#### Jenkins 集成 Ant

Jenkins->Manage Jenkins->Manage Plugins，点击Advanced

![image-20220621162515254](/img/image-20220621162515254.png)

jenkins --> 系统管理 --> 全局工具配置

![image-20220621162749268](/img/image-20220621162749268.png)

jenkins --> 全局工具配置 --> 全局工具配置

![image-20220621162302593](/img/image-20220621162302593.png)

测试

![image-20220621163803833](/img/image-20220621163803833.png)

### Jenkins 集成 Npm

前端项目的构建通常需要使用 npm。npm 首先需要安装 nodejs。

> 下载链接：https://nodejs.org/en/download/

![image-20220621163945773](/img/image-20220621163945773.png)

#### Jenkins 集成 Npm

```shell
$ tar xf node-v16.15.1-linux-x64.tar.xz -C /usr/local/
$ vim /etc/profile
$ export NODE_HOME=/usr/local/node-v16.15.1-linux-x64
$ export PATH=$PATH:$NODE_HOME/bin
$ source /etc/profile
```

![image-20220621164217487](/img/image-20220621164217487.png)

#### jenkins 集成 Npm

Jenkins->Manage Jenkins->Manage Plugins，点击Advanced

![image-20220621164419983](/img/image-20220621164419983.png)

jenkins --> 系统管理 --> 全局工具配置

![image-20220621164617703](/img/image-20220621164617703.png)

jenkins --> 全局工具配置 --> 全局工具配置

![image-20220621164900311](/img/image-20220621164900311.png)

测试

![image-20220621164742569](/img/image-20220621164742569.png)

### Jenkins 集成禅道

禅道是我们在企业中经常用到的一个工具。

> 集成文档：https://www.zentao.net/book/zentaopmshelp/393.html

#### Jenkins 安装 插件

Jenkins->Manage Jenkins->Manage Plugins，点击Advanced

![image-20220621181029479](/img/image-20220621181029479.png)

#### 安装禅道

```bash
$ docker run --name chandao -p 80:80 -v /opt/chandao:/www/zentaopms \
       -v /opt/chandao_mysql:/var/lib/mysql \
       -e MYSQL_ROOT_PASSWORD=123456 -d easysoft/zentao
```

#### 配置 Jenkins 

![image-20220621181352310](/img/image-20220621181352310.png)

![image-20220621181426669](/img/image-20220621181426669.png)

![image-20220621182128265](/img/image-20220621182128265.png)

![image-20220621182140958](/img/image-20220621182140958.png)

测试

![image-20220621182959182](/img/image-20220621182959182.png)

![image-20220621183042108](/img/image-20220621183042108.png)

### Jenkins 集成 SonarQube

SonarQube是一个用于管理代码质量的开放平台，可以快速的定位代码中潜在的或者明显的错误。目前 支持java,C#,C/C++,Python,PL/SQL,Cobol,JavaScrip,Groovy等二十几种编程语言的代码质量管理与检测。通过SonarQube 我们还可以检测出项目中重复代码， 潜在bug， 代码规范，安全性漏洞等问题， 并通过SonarQube web UI展示出来。 

#### 安装 SonarQube

> 官网：https://www.sonarqube.org/

![image-20220621193010196](/img/image-20220621193010196.png)

#### 部署前提

运行 SonarQube 的唯一先决条件是在您的机器上安装 Java（Oracle JRE 11 或 OpenJDK 11）。同时还需要满足如下条件：

- `vm.max_map_count`大于或等于 524288
- `fs.file-max`大于或等于 131072

- 运行 SonarQube 的用户可以打开至少 131072 个文件描述符
- 运行 SonarQube 的用户至少可以打开 8192 个线程

```bash
$ sysctl -w vm.max_map_count=524288
$ sysctl -w fs.file-max=131072
$ ulimit -n 131072
$ ulimit -u 8192
```

![image-20220621193052081](/img/image-20220621193052081.png)

```bash
$ yum install java-11-openjdk.x86_64 -y
$ yum install java-11-openjdk-devel -y
$ wget https://binaries.sonarsource.com/Distribution/sonarqube/sonarqube-8.9.8.54436.zip
$ unzip sonarqube-8.9.8.54436.zip 
$ mv sonarqube-8.9.8.54436 /usr/local/

# 创建用户
$ useradd sonar

# 授权
$ chown -R sonar /usr/local/sonarqube-8.9.8.54436
```

#### 部署 postgresql 数据库

为了方便，这里采用docker的方式部署，在企业生产环境中建议部署在虚拟机中。

```bash
$ docker run --name postgresql \
  -e POSTGRESQL_USERNAME=root \
  -e POSTGRESQL_PASSWORD=123456 \
  -e POSTGRESQL_DATABASE=sonar \
  -p 5432:5432 \
  bitnami/postgresql:latest
```

#### 部署 SonarQube

```bash
$ vim /usr/local/sonarqube-8.9.8.54436/conf/sonar.properties 
sonar.jdbc.url=jdbc:postgresql://172.16.0.30/sonar?currentSchema=public
sonar.jdbc.username=root
sonar.jdbc.password=123456
```

#### 启动 SonarQube

> 需要注意的是，SonarQube 默认不支持 root 用户启动，所以如果需要启动 SonarQube 需要用一个普通用户启动。

```bash
# 启动
$ su sonar ./bin/linux-x86-64/sonar.sh start 
Starting SonarQube...
Started SonarQube.
# 查看状态
$ su sonar ./bin/linux-x86-64/sonar.sh status
SonarQube is running (1528).
# 停止
$ su sonar ./bin/linux-x86-64/sonar.sh stop
```

这里需要注意的是，SonarQube 最长出现问题的地方是 ES，所以我们可以查看 ES 的日志，根据日志的具体报错信息逐一解决。

访问：http://192.168.15.21:9000

默认用户名密码均为：admin

![image-20220621200215879](/img/image-20220621200215879.png)

![image-20220621200354319](/img/image-20220621200354319.png)

#### 集成 Gitlab 单点登录

sonarqube 支持多种认证登录方式，如果使用自带的账号体系，需要管理员一个个添加账号，使用起来多有不便。不过一般公司都部署了私有化的 [Gitlab](https://so.csdn.net/so/search?q=Gitlab&spm=1001.2101.3001.7020)，我们可以利用私有的 gitlab 账号来登录 Sonarqube。

> 注意：如果 SonarQube 的 URL 不是 HTTPS 的话，则设置的 GitLab 单点登录会失败。

![image-20220621200637068](/img/image-20220621200637068.png)

![image-20220621200803132](/img/image-20220621200803132.png)

```bash
http://[sonarhost]:[port]/oauth2/callback/gitlab
```

![image-20220621200925885](/img/image-20220621200925885.png)

![image-20220621201009939](/img/image-20220621201009939.png)

#### 汉化 SonarQube

![image-20220621202110592](/img/image-20220621202110592.png)



#### Jenkins 集成 SonarQube

上面我们已经成功安装了 SonarQube，这里我们使用 Jenkins 来调用 SonarQube。

##### 安装 sonarqube-Scanner 插件

Jenkins->Manage Jenkins->Manage Plugins，点击Advanced

![image-20220622012316870](/img/image-20220622012316870.png)

##### 添加SonarQube凭证

SonarQube 凭证是 Jenkins 访问 SonarQube 凭证。

###### 创建令牌凭证

![image-20220622012647926](/img/image-20220622012647926.png)

![image-20220622012738410](/img/image-20220622012738410.png)

![image-20220622012833355](/img/image-20220622012833355.png)

##### Jenkins进行SonarQube配置

Jenkins -> 系统配置 -> SonarQube servers

![image-20220622013038778](/img/image-20220622013038778.png)

 Jenkins -> 全局工具配置

![image-20220622013244596](/img/image-20220622013244596.png)

##### SonaQube关闭审查结果上传到SCM功能

![image-20220622013351346](/img/image-20220622013351346.png)

##### 测试 Jenkins 链接 SonarQube

> 官方文档：https://docs.sonarqube.org/8.9/analysis/scan/sonarscanner-for-jenkins/

###### 在 Java 项目中增加配置文件

![image-20220622013700381](/img/image-20220622013700381.png)

###### 测试 pipeline

```groovy
pipeline{
    agent any
    stages{
        stage("拉取代码"){
            steps {
                checkout([$class: 'GitSCM', branches: [[name: '*/main']], extensions: [], userRemoteConfigs: [[credentialsId: '68a87abf-6af7-4e60-94dd-cf45c280c247', url: 'git@gitlab.abck8s.com:xiaoyangaijishu/spring-cloud-eureka-master.git']]])
            }
        }
        stage("编译构建"){
            steps {
                sh """
                	mvn clean package
                """
            }
        }
        stage("SonarQube代码审查"){
            steps {
                script {
                    scannerHome = tool 'sonarqube-scanner'
                }
            	withSonarQubeEnv('sonarqube8.9.8') {
                	sh "${scannerHome}/bin/sonar-scanner"
            	}
            }
        }
    }
}
```

![image-20220622124231200](/img/image-20220622124231200.png)

我们可以看到的是，Jenkins 已经成功调用 sonarscanner，并把该项目分析分析结果成功放在了 SonarQube 中。

#### SonarQube 质量阀

通常，我们扫描代码之后，如果出现了 BUG，那么此时我们应该停止部署，这个就是需要用到 SonarQube 质量阀。设置 SonarQube 质量阀需要两个步骤，分别是设置质量阀和 pipline 判断。

##### 设置 SonarQube 质量阀

![image-20220623135532583](/img/image-20220623135532583.png)

![image-20220623135633016](/img/image-20220623135633016.png)

![image-20220623135817012](/img/image-20220623135817012.png)

![image-20220623135849805](/img/image-20220623135849805.png)

```bash
https://jenkins.abck8s.com/sonarqube-webhook/
```

##### pipline 判断

![image-20220623140038120](/img/image-20220623140038120.png)

###### 添加 pipeline 语法

```groovy
pipeline{
    agent any
    stages{
        stage("拉取代码"){
            steps {
                checkout([$class: 'GitSCM', branches: [[name: '*/main']], extensions: [], userRemoteConfigs: [[credentialsId: '68a87abf-6af7-4e60-94dd-cf45c280c247', url: 'git@gitlab.abck8s.com:xiaoyangaijishu/spring-cloud-eureka-master.git']]])
            }
        }
        stage("SonarQube代码审查"){
            steps {
                script {
                    scannerHome = tool 'sonarqube-scanner'
                }
            	withSonarQubeEnv('sonarqube8.9.8') {
                	sh "${scannerHome}/bin/sonar-scanner"
            	}
            }
        }
        stage("判断代码扫描状态"){
        	steps {
    			script {
    			    timeout(5) {
    				    qg = waitForQualityGate()
        				if (qg.status != 'OK') {
          					error "扫描失败，状态错误: ${qg.status}"
                        } else {
                            echo "扫描成功"
                        }
    				}
 			 	}
            }
        }
        stage("编译构建"){
            steps {
                sh """
                	mvn clean package
                """
            }
        }
    }
}
```

![image-20220623140328818](/img/image-20220623140328818.png)

![image-20220623140352769](/img/image-20220623140352769.png)
