---
title: 第07章：ipv4 与 ipv6 双栈 k8s 集群 kubeadm 安装
date: 2022-07-07 08:52:48
permalink: /pages/41536d/
categories:
  - kubernetes
tags:
  - 
author: 
  name: 小阳爱技术
  link: https://blog.abck8s.com
---
# 第07章：ipv4 与 ipv6 双栈 k8s 集群 kubeadm 安装

Kubernetes有两种方式，第一种是二进制的方式，可定制但是部署复杂容易出错；第二种是kubeadm工具安装，部署简单，不可定制化。本次我们部署kubeadm版。

## 一、部署之前的一些优化

在部署之前，我们需要先优化系统，下载不要软件。

### 1. 部署系统版本

| 软件            | 版本                                                         |
| --------------- | ------------------------------------------------------------ |
| CentOS          | CentOS Linux release 7.9.2009 (Core)                         |
| Docker          | 19.03.12                                                     |
| Kubernetes      | V1.22                                                        |
| Calico          | V3.23                                                        |
| Kernel-lt       | [kernel-lt-5.4.203-1.el7.elrepo.x86_64.rpm](https://elrepo.org/linux/kernel/el7/x86_64/RPMS/kernel-lt-5.4.203-1.el7.elrepo.x86_64.rpm) |
| Kernel-lt-devel | [kernel-lt-devel-5.4.203-1.el7.elrepo.x86_64.rpm](https://elrepo.org/linux/kernel/el7/x86_64/RPMS/kernel-lt-devel-5.4.203-1.el7.elrepo.x86_64.rpm) |

### 2. 节点规划

| Hostname | Ipv4          | Ipv6                    | 内核版本  |
| -------- | ------------- | ----------------------- | --------- |
| k8s-m-01 | 192.168.15.61 | fd15:4ba5:5a2b:1008::61 | 5.4.203-1 |
| K8s-m-02 | 192.168.15.62 | fd15:4ba5:5a2b:1008::62 | 5.4.203-1 |
| K8s-m-03 | 192.168.15.63 | fd15:4ba5:5a2b:1008::63 | 5.4.203-1 |
| K8s-n-01 | 192.168.15.64 | fd15:4ba5:5a2b:1008::64 | 5.4.203-1 |
| K8s-n-02 | 192.168.15.65 | fd15:4ba5:5a2b:1008::65 | 5.4.203-1 |
| lb01     | 192.168.15.71 | fd15:4ba5:5a2b:1008::71 | 5.4.203-1 |
| lb02     | 192.168.15.72 | fd15:4ba5:5a2b:1008::72 | 5.4.203-1 |
| vip      | 192.168.15.73 |                         | 5.4.203-1 |

### 3. 关闭selinux

```bash
# 永久关闭
sed -i 's#enforcing#disabled#g' /etc/selinux/config
# 零时关闭
setenforce 0
```

### 4. 关闭swap分区

```bash
swapoff -a
sed -i.bak 's/^.*centos-swap/#&/g' /etc/fstab
echo 'KUBELET_EXTRA_ARGS="--fail-swap-on=false"' > /etc/sysconfig/kubelet
```

### 5. 配置国内yum源

默认情况下，CentOS使用的是官方yum源，所以一般情况下在国内使用是非常慢，所以我们可以替换成国内的一些比较成熟的yum源，例如：清华大学镜像源，网易云镜像源等等。

```bash
mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup
curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo
curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo

# 刷新缓存
yum makecache

# 更新系统
yum update -y --exclud=kernel*
```

### 6. 升级内核版本

由于Docker运行需要较新的系统内核功能，例如ipvs等等，所以一般情况下，我们需要使用4.0+以上版本的系统内核。

```bash
# 内核要求是4.18+，如果是`CentOS 8`则不需要升级内核

wget https://elrepo.org/linux/kernel/el7/x86_64/RPMS/kernel-lt-5.4.203-1.el7.elrepo.x86_64.rpm
wget https://elrepo.org/linux/kernel/el7/x86_64/RPMS/kernel-lt-devel-5.4.204-1.el7.elrepo.x86_64.rpm

yum localinstall -y kernel-lt*

grub2-set-default  0 && grub2-mkconfig -o /etc/grub2.cfg

grubby --default-kernel

# 重启
reboot
```

### 7. 安装ipvs

ipvs是系统内核中的一个模块，其网络转发性能很高。一般情况下，我们首选ipvs。

```bash
# 安装IPVS
yum install -y conntrack-tools ipvsadm ipset conntrack libseccomp

# 加载IPVS模块
cat > /etc/sysconfig/modules/ipvs.modules <<EOF
#!/bin/bash
ipvs_modules="ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_fo ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack"
for kernel_module in \${ipvs_modules}; do
  /sbin/modinfo -F filename \${kernel_module} > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    /sbin/modprobe \${kernel_module}
  fi
done
EOF

chmod 755 /etc/sysconfig/modules/ipvs.modules && bash /etc/sysconfig/modules/ipvs.modules && lsmod | grep ip_vs
```

### 8. 内核参数优化

内核参数优化的主要目的是使其更适合kubernetes的正常运行。

```bash
cat > /etc/sysctl.d/k8s.conf << EOF
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
fs.may_detach_mounts = 1
vm.overcommit_memory=1
vm.panic_on_oom=0
fs.inotify.max_user_watches=89100
fs.file-max=52706963
fs.nr_open=52706963

net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp.keepaliv.probes = 3
net.ipv4.tcp_keepalive_intvl = 15
net.ipv4.tcp.max_tw_buckets = 36000
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp.max_orphans = 327680
net.ipv4.tcp_orphan_retries = 3
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.ip_conntrack_max = 65536
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.top_timestamps = 0
net.core.somaxconn = 16384

net.ipv6.conf.all.disable_ipv6 = 0
net.ipv6.conf.default.disable_ipv6 = 0
net.ipv6.conf.lo.disable_ipv6 = 0
net.ipv6.conf.all.forwarding = 1

EOF

# 立即生效
sysctl --system

```

### 9. 安装基础软件

安装一些基础软件，是为了方便我们的日常使用。

```bash
yum install wget expect vim net-tools ntp bash-completion ipvsadm ipset jq iptables conntrack sysstat libseccomp -y
```

### 10. 关闭防火墙

关闭防火墙是为了方便日常使用，不会给我们造成困扰。在生成环境中建议打开。

```bash
systemctl disable --now firewalld
```
### 11. 同步集群时间

在集群当中，时间是一个很重要的概念，一旦集群当中某台机器时间跟集群时间不一致，可能会导致集群面临很多问题。所以，在部署集群之前，需要同步集群当中的所有机器的时间。

```bash
yum install ntp -y

ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
echo 'Asia/Shanghai' > /etc/timezone

ntpdate time2.aliyun.com

# 写入定时任务
*/1 * * * * ntpdate time2.aliyun.com > /dev/null 2>&1
```

### 12. 配置主机名和IP

当前，我们需要安装的是 ipv4 和 ipv6 双栈 k8s 集群，所以在安装部署之前，需要将 ipv4 和 ipv6 两种ip和主机名解析好。

注意：不建议只开启 ipv6 ，部分共有docker仓库还不支持 ipv6。

```bash
# 这里以修改 k8s-m-01 这台机器为例，其他机器以此类推。
# 解析主机名
$ cat >> /etc/hosts <EOF
fd15:4ba5:5a2b:1008::61 k8s-m-01
fd15:4ba5:5a2b:1008::62 k8s-m-02
fd15:4ba5:5a2b:1008::63 k8s-m-03
fd15:4ba5:5a2b:1008::64 k8s-n-01
fd15:4ba5:5a2b:1008::65 k8s-n-02

192.168.15.61 k8s-m-01
192.168.15.62 k8s-m-02
192.168.15.63 k8s-m-03
192.168.15.64 k8s-n-01
192.168.15.65 k8s-n-02

192.168.15.71 lb01
192.168.15.72 lb02
192.168.15.73 lb-vip
EOF

$ vim /etc/sysconfig/network-scripts/ifcfg-eth0 
IPV6_AUTOCONF=no
IPV6ADDR=fd15:4ba5:5a2b:1008::61
IPV6_DEFAULTGW=fd15:4ba5:5a2b:1008::2
DNS1=101.6.6.6
DNS2=2001:da8::666
```

## 二、安装Docker

docker 作为底层运行时，必须在安装 k8s 之前部署好。

```bash
yum install -y yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

yum install docker-ce-19.03.12 -y
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": ["https://8mh75mhz.mirror.aliyuncs.com"]
}
EOF
sudo systemctl daemon-reload ; systemctl restart docker;systemctl enable --now docker.service
```

## 三、安装 k8s

### 1. 配置Kubernetes源

```bash
cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF

setenforce 0

yum install kubelet-1.22.1 kubeadm-1.22.1 kubectl-1.22.1

systemctl enable kubelet && systemctl start kubelet
```

### 2. 初始化 Master 节点
